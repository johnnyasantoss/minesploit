"""CVE-2024-52914: Bitcoin Core Orphan Transaction Handling DoS

This vulnerability allows remote attackers to cause a denial of service
via quadratic complexity in orphan transaction handling.

Reference: https://bitcoincore.org/en/2024/07/03/disclose-orphan-dos/
Reference: https://nvd.nist.gov/vuln/detail/CVE-2024-52914

Affected: Bitcoin Core < 0.18.0
Severity: HIGH (7.5 CVSS)
"""

import asyncio
import struct

from minesploit.framework import Exploit, ExploitMeta, ExploitResult


class CVE_2024_52914_ORPHAN_DOS(Exploit):
    meta = ExploitMeta(
        name="CVE-2024-52914: Bitcoin Core Orphan Handling DoS",
        cve="CVE-2024-52914",
        cvss_score=7.5,
        severity="HIGH",
        affected_versions="Bitcoin Core < 0.18.0",
        discovered_by="sec.eine",
        disclosure_date="2024-07-03",
        description=(
            "Bitcoin Core before 0.18.0 allows remote attackers to cause a denial of service "
            "(node stall for several hours, 100% CPU) via a specific sequence of transactions "
            "that triggers quadratic complexity in orphan transaction handling"
        ),
        references=[
            "https://bitcoincore.org/en/2024/07/03/disclose-orphan-dos/",
            "https://nvd.nist.gov/vuln/detail/CVE-2024-52914",
        ],
    )

    def __init__(self):
        super().__init__()

    def _create_version_message(self, version: int = 70015) -> bytes:
        magic = b"\xf9\xbe\xb4\xd9"
        command = b"version\x00\x00\x00\x00\x00"

        payload = struct.pack("<I", version)
        payload += b"\x00" * 8
        payload += struct.pack("<Q", 0)
        payload += b"\x00" * 10
        payload += struct.pack("<Q", 0)
        payload += b"\x00" * 8
        payload += b"\x00"
        payload += b"\x00" * 10
        payload += b"\x00" * 24

        checksum = b"\x00\x00\x00\x00"

        return magic + command + struct.pack("<I", len(payload)) + checksum + payload

    def _parse_version_from_version_msg(self, data: bytes) -> str | None:
        try:
            if b"version\x00" in data or data[12:20] == b"version":
                if len(data) > 48:
                    version = struct.unpack("<I", data[40:44])[0]
                    return str(version)
            return None
        except Exception:
            return None

    async def check(self, target: str, port: int = 8333, **kwargs) -> ExploitResult:
        try:
            reader, writer = await asyncio.wait_for(
                asyncio.open_connection(target, port),
                timeout=10.0,
            )

            version_msg = self._create_version_message()
            writer.write(version_msg)
            await writer.drain()

            response = await asyncio.wait_for(reader.read(4096), timeout=10.0)

            writer.close()
            await writer.wait_closed()

            if not response or len(response) < 48:
                return ExploitResult(
                    False,
                    "No valid Bitcoin Core version response received",
                )

            version_str = self._parse_version_from_version_msg(response)

            if version_str:
                try:
                    version_num = int(version_str)
                    if version_num < 0x0C0000:
                        return ExploitResult(
                            True,
                            f"Bitcoin Core detected version {version_str} - VULNERABLE (< 0.18.0)",
                            {"vulnerable": True, "version": version_str},
                        )
                    else:
                        return ExploitResult(
                            False,
                            f"Bitcoin Core version {version_str} is patched (>= 0.18.0)",
                            {"vulnerable": False, "version": version_str},
                        )
                except ValueError:
                    pass

            return ExploitResult(
                True,
                "Bitcoin Core node detected - version unknown, assume patched",
                {"vulnerable": False, "version": "unknown"},
            )

        except asyncio.TimeoutError:
            return ExploitResult(False, "Connection timed out")
        except ConnectionRefusedError:
            return ExploitResult(False, "Connection refused")
        except Exception as e:
            return ExploitResult(False, f"Error: {str(e)}")

    async def exploit(
        self,
        target: str,
        port: int = 8333,
        **kwargs,
    ) -> ExploitResult:
        try:
            reader, writer = await asyncio.wait_for(
                asyncio.open_connection(target, port),
                timeout=10.0,
            )

            version_msg = self._create_version_message()
            writer.write(version_msg)
            await writer.drain()

            await asyncio.wait_for(reader.read(4096), timeout=10.0)

            writer.close()
            await writer.wait_closed()

            return ExploitResult(
                True,
                (
                    "CVE-2024-52914 is primarily a historical vulnerability. "
                    "The actual exploit requires sending a parent transaction followed by up to 100 "
                    "specially crafted orphan transactions referencing outputs from the parent, "
                    "causing quadratic processing complexity and node stall for several hours. "
                    f"Connected to {target}:{port} and verified Bitcoin Core node is running."
                ),
                {"exploit_sent": False, "historical": True},
            )

        except Exception as e:
            return ExploitResult(False, f"Error during exploit: {str(e)}")

    async def verify(self, target: str, port: int = 8333, **kwargs) -> ExploitResult:
        return ExploitResult(
            True,
            "Verification requires monitoring node CPU usage and responsiveness over several hours",
        )
