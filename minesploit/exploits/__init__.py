"""Minesploit exploit modules - dynamically discovered"""

import importlib
import pkgutil
from pathlib import Path
from typing import Any

from minesploit.database import register_exploit
from minesploit.framework import Exploit

_EXPLOIT_CACHE: dict[str, type[Exploit]] = {}
_SCANNED: bool = False


def _scan_exploits() -> None:
    global _SCANNED
    if _SCANNED:
        return

    for importer in pkgutil.iter_modules([str(Path(__file__).parent)]):
        module = importlib.import_module(f"minesploit.exploits.{importer.name}")
        for attr_name in dir(module):
            attr = getattr(module, attr_name)
            if isinstance(attr, type) and issubclass(attr, Exploit) and attr is not Exploit:
                register_exploit(attr.meta)
                _EXPLOIT_CACHE[attr_name] = attr

    _SCANNED = True


def __getattr__(name: str) -> Any:
    if name.startswith("_"):
        raise AttributeError(name)

    _scan_exploits()

    if name in _EXPLOIT_CACHE:
        return _EXPLOIT_CACHE[name]

    raise AttributeError(f"module {__name__!r} has no attribute {name!r}")


def __dir__() -> list[str]:
    _scan_exploits()
    return list(_EXPLOIT_CACHE.keys())
