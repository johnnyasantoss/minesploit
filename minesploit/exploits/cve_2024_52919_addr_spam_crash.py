"""CVE-2024-52919: Bitcoin Core addr Message Spam DoS

This vulnerability allows remote attackers to crash Bitcoin Core nodes via
sustained addr message spam that causes an integer overflow in the address
manager (addrman). After the fix in v22.0 (rate limiting), exploitation
would take over a year even with 1000 attacker-controlled peers.

Reference: https://bitcoincore.org/en/2025/04/28/disclose-cve-2024-52919/
Reference: https://nvd.nist.gov/vuln/detail/CVE-2024-52919

Affected: Bitcoin Core < 22.0 (original), 22.0 - 28.x (remaining attack)
Fixed: v22.0 (rate limiting), v29.0 (64-bit nId)
Severity: LOW (Bitcoin Core) / MEDIUM (CISA-ADP: 6.5)
"""

import asyncio

from minesploit.framework import Exploit, ExploitMeta, ExploitResult


class CVE_2024_52919_ADDR_SPAM_DOS(Exploit):
    meta = ExploitMeta(
        name="CVE-2024-52919: Bitcoin Core addr Message Spam DoS",
        cve="CVE-2024-52919",
        cvss_score=6.5,
        severity="MEDIUM",
        affected_versions="Bitcoin Core < 22.0 (original) / < 29.0 (remaining)",
        discovered_by="Eugene Siegel",
        disclosure_date="2025-04-28",
        description=(
            "Bitcoin Core's addrman uses a 32-bit counter (nId) that can overflow "
            "with sustained addr message spam, causing assertion failures and node crash. "
            "Part 1 (before v22.0) was fixed with rate limiting. Part 2 (v22.0-v28.x) "
            "was fixed in v29.0 by changing nId to 64-bit. Even with rate limiting, "
            "exploitation would take >1 year with 1000 peers."
        ),
        references=[
            "https://bitcoincore.org/en/2025/04/28/disclose-cve-2024-52919/",
            "https://github.com/bitcoin/bitcoin/pull/22387",
            "https://github.com/bitcoin/bitcoin/pull/30568",
        ],
    )

    async def check(self, target: str, port: int = 8333, **kwargs) -> ExploitResult:
        try:
            reader, writer = await asyncio.wait_for(
                asyncio.open_connection(target, port),
                timeout=10.0,
            )

            version_msg = self._create_version_message()
            writer.write(version_msg)
            await writer.drain()

            response = await asyncio.wait_for(reader.read(1024), timeout=10.0)

            verack_msg = b"\xf9\xbe\xb4\xd9verack\x00\x00\x00\x00\x00\x00\x00\x00\x00"
            writer.write(verack_msg)
            await writer.drain()

            response = await asyncio.wait_for(reader.read(1024), timeout=10.0)

            writer.close()
            await writer.wait_closed()

            if response and len(response) > 0:
                return ExploitResult(
                    True,
                    "Bitcoin Core node detected. Version check required for vulnerability status.",
                    {"vulnerable": "Unknown", "service": "bitcoind"},
                )

            return ExploitResult(False, "No Bitcoin Core response detected")

        except asyncio.TimeoutError:
            return ExploitResult(False, "Connection timed out")
        except ConnectionRefusedError:
            return ExploitResult(False, "Connection refused")
        except Exception as e:
            return ExploitResult(False, f"Error: {str(e)}")

    def _create_version_message(self) -> bytes:
        import struct

        magic = b"\xf9\xbe\xb4\xd9"
        command = b"version\x00\x00\x00\x00\x00"

        payload = struct.pack("<I", 70015)
        payload += b"\x00" * 8
        payload += struct.pack("<Q", 0)
        payload += b"\x00" * 10
        payload += struct.pack("<Q", 0)
        payload += b"\x00" * 8
        payload += b"\x00"
        payload += b"\x00" * 10
        payload += b"\x00" * 24

        checksum = b"\x00\x00\x00\x00"

        return magic + command + struct.pack("<I", len(payload)) + checksum + payload

    async def exploit(
        self,
        target: str,
        port: int = 8333,
        **kwargs,
    ) -> ExploitResult:
        return ExploitResult(
            False,
            "Exploit not implemented - requires months of sustained addr spam "
            "to overflow 32-bit counter. Rate limiting in v22.0 makes this "
            "impractical. Primary value is version detection: <22.0 (original), "
            "22.0-28.x (remaining), 29.0+ (patched).",
        )

    async def verify(self, target: str, port: int = 8333, **kwargs) -> ExploitResult:
        return ExploitResult(
            True,
            "Verification requires version check: Bitcoin Core < 22.0 or 22.0-28.x may be vulnerable",
        )
